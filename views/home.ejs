<% title = 'Vexa ‚Äì Shop the Future' %>

<!-- Hero -->
<section class="hero">
  <div class="container">
    <h1>Welcome to Vexa</h1>
    <p>Discover the future of shopping ‚Äî curated tech, gourmet eats, and smart living.</p>
  </div>
</section>

<!-- Categories -->
<section class="categories-section">
  <div class="container">
    <h2>Shop by Category</h2>
    <div class="category-grid">
      <!-- ‚úÖ VIEW ALL -->
      <a href="/" class="category-card all <%= !locals.category ? 'active' : '' %>">
        <div class="category-icon">üåü</div>
        <h3>View All</h3>
      </a>
      
      <% const categories = ['Electronics', 'Gadgets', 'Foods', 'Fashion']; %>
      <% categories.forEach(cat => { %>
        <a href="/?category=<%= cat %>" class="category-card <%= cat.toLowerCase() %> <%= locals.category === cat ? 'active' : '' %>">
          <div class="category-icon">üõí</div>
          <h3><%= cat %></h3>
        </a>
      <% }); %>
    </div>
  </div>
</section>

<!-- Products -->
<section class="products-section">
  <div class="container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
      <h2>Featured Products</h2>
      <% if (locals.category) { %>
        <div style="display: flex; align-items: center; gap: 1rem;">
          <span class="category-tag">Category: <strong><%= category %></strong></span>
          <a href="/" class="clear-filter">Clear Filter</a>
        </div>
      <% } %>
    </div>
    
    <% if (products && products.length > 0) { %>
      <div class="products-grid">
        <% products.forEach(product => { %>
          <div class="product-card">
            <div class="product-badge"><%= product.category %></div>
            <div class="product-image">‚ú®</div>
            <div class="product-info">
              <h3><%= product.name %></h3>
              <p class="description"><%= product.description %></p>
              <p class="price">$<%= product.price.toFixed(2) %></p>
              
              <div style="display: flex; gap: 0.5rem; margin-top: 0.75rem;">
                <button type="button"
                  class="btn add-to-cart-btn"
                  data-product-id="<%= product._id %>"
                  data-product-name="<%= product.name %>"
                  data-product-stock="<%= product.stock %>">
                  Add to Cart
                </button>
                <button type="button" 
                  class="btn order-now-btn"
                  data-product-id="<%= product._id %>"
                  data-product-name="<%= product.name %>"
                  data-product-price="<%= product.price %>"
                  style="background:#0ea5e9;">
                  Order Now
                </button>
              </div>
            </div>
          </div>
        <% }) %>
      </div>
    <% } else { %>
      <p class="no-products">No products found. <a href="/">View all products</a>.</p>
    <% } %>
  </div>
</section>

<!-- Modals -->
<div id="quantityModal" class="modal" style="display:none;">
  <div class="modal-content" style="max-width:400px; margin:50px auto; padding:2rem; background:white; border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,0.2);">
    <h3 id="quantityModalTitle">Select Quantity</h3>
    <p id="quantityModalInfo" style="margin:0.5rem 0 1.5rem; color:#6b7280;"></p>
    
    <div style="display:flex; justify-content:center; gap:1rem; margin:1.5rem 0;">
      <button type="button" id="qtyDec" style="width:40px; height:40px; border:1px solid #e5e7eb; border-radius:50%; background:white; font-size:1.25rem; color:#8b5cf6;">‚àí</button>
      <input type="number" id="quantityInput" min="1" max="30" value="1" 
        style="width:80px; padding:0.5rem; text-align:center; border:1px solid #e5e7eb; border-radius:8px; font-size:1.1rem;" />
      <button type="button" id="qtyInc" style="width:40px; height:40px; border:1px solid #e5e7eb; border-radius:50%; background:white; font-size:1.25rem; color:#8b5cf6;">+</button>
    </div>
    
    <div style="text-align:right;">
      <button type="button" id="cancelQty" style="background:#6b7280; color:white; border:none; padding:0.5rem 1.25rem; border-radius:8px; margin-right:0.5rem;">Cancel</button>
      <button type="button" id="confirmQty" style="background:#8b5cf6; color:white; border:none; padding:0.5rem 1.25rem; border-radius:8px;">Add to Cart</button>
    </div>
  </div>
</div>

<div id="orderModal" class="modal" style="display:none;">
  <div class="modal-content" style="max-width:500px; margin:50px auto; padding:2rem; background:white; border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,0.2);">
    <h2>Confirm Your Order</h2>
    <div id="orderSummary"></div>
    
    <label>Shipping Address</label>
    <textarea name="shippingAddress" id="modalAddress" required 
      style="width:100%; margin:0.5rem 0; padding:0.5rem;"
      placeholder="Enter your shipping address"><%= (typeof user !== 'undefined' && user.address) ? user.address : '' %></textarea>
    
    <label>Payment Method</label>
    <select name="paymentMethod" id="modalPayment" required style="width:100%; margin:0.5rem 0; padding:0.5rem;">
      <option value="cod">Cash on Delivery</option>
      <option value="gcash">GCash</option>
      <option value="maya">Maya</option>
      <option value="bank">Bank Transfer</option>
    </select>
    
    <div style="margin:1rem 0;">
      <strong>Total: $<span id="modalTotal">0.00</span></strong>
    </div>
    
    <div style="text-align:right; margin-top:1rem;">
      <button type="button" id="closeModalBtn" style="background:#6b7280; color:white; border:none; padding:0.5rem 1.25rem; margin-right:0.5rem; border-radius:8px;">Cancel</button>
      <button type="button" id="submitOrderBtn" style="background:#0ea5e9; color:white; border:none; padding:0.5rem 1.25rem; border-radius:8px;">Place Order</button>
    </div>
  </div>
</div>

<div id="cartToast" class="toast"></div>
<div id="successToast" class="toast">Order placed successfully!</div>

<style>
  .hero {
    background: linear-gradient(120deg, #8b5cf6, #06b6d4);
    color: white;
    padding: 4rem 0;
    text-align: center;
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
  }
  .hero h1 { font-size: 2.8rem; margin-bottom: 1rem; }
  .hero p { font-size: 1.2rem; opacity: 0.95; max-width: 600px; margin: 0 auto; }

  .categories-section {
    padding: 3rem 0;
    background: #f8fafc;
  }
  .categories-section h2 {
    text-align: center;
    margin-bottom: 2rem;
    color: #1e293b;
  }
  .category-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    gap: 1.5rem;
    max-width: 900px;
    margin: 0 auto;
  }
  .category-card {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 1.5rem 1rem;
    background: white;
    border-radius: 16px;
    text-decoration: none;
    color: #1e293b;
    box-shadow: 0 4px 12px rgba(0,0,0,0.06);
    transition: transform 0.2s, box-shadow 0.2s;
  }
  .category-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 6px 16px rgba(0,0,0,0.12);
  }
  .category-card.active {
    box-shadow: 0 0 0 3px #8b5cf6, 0 6px 16px rgba(0,0,0,0.12);
    transform: translateY(-2px);
  }
  .category-icon {
    font-size: 2.5rem;
    margin-bottom: 0.75rem;
  }
  .category-card h3 {
    font-size: 1.1rem;
    font-weight: 600;
  }
  .electronics { border-top: 4px solid #8b5cf6; }
  .gadgets { border-top: 4px solid #0ea5e9; }
  .foods { border-top: 4px solid #10b981; }
  .fashion { border-top: 4px solid #ec4899; }
  .home { border-top: 4px solid #f59e0b; }
  .all { border-top: 4px solid #8b5cf6; }

  .products-section {
    padding: 3rem 0;
  }
  .products-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 2rem;
  }
  .product-card {
    background: white;
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 6px 16px rgba(0,0,0,0.08);
    transition: transform 0.2s;
    position: relative;
  }
  .product-card:hover {
    transform: translateY(-6px);
  }
  .product-badge {
    position: absolute;
    top: 1rem;
    right: 1rem;
    background: #f0fdf4;
    color: #059669;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
  }
  .product-image {
    height: 180px;
    background: #f1f5f9;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 3rem;
    color: #94a3b8;
  }
  .product-info {
    padding: 1.5rem;
  }
  .product-info h3 {
    font-size: 1.25rem;
    margin-bottom: 0.5rem;
    color: #1e293b;
  }
  .description {
    color: #64748b;
    font-size: 0.95rem;
    margin-bottom: 0.75rem;
    line-height: 1.5;
  }
  .price {
    font-weight: 700;
    font-size: 1.35rem;
    color: #8b5cf6;
    margin: 0.5rem 0;
  }
  .btn {
    flex: 1;
    padding: 0.65rem;
    border-radius: 10px;
    font-weight: 600;
    font-size: 0.95rem;
    border: none;
    cursor: pointer;
    text-align: center;
  }
  .btn:hover {
    opacity: 0.95;
  }
  .add-to-cart-btn {
    background: #8b5cf6;
    color: white;
  }
  .order-now-btn {
    background: #0ea5e9;
    color: white;
  }

  .category-tag {
    background: #e0f2fe;
    color: #0369a1;
    padding: 0.4rem 1rem;
    border-radius: 20px;
    font-weight: 600;
  }
  .clear-filter {
    color: #8b5cf6;
    text-decoration: underline;
    font-weight: 600;
  }
  .no-products {
    text-align: center;
    color: #64748b;
    padding: 2rem;
    font-size: 1.1rem;
  }
  .no-products a {
    color: #8b5cf6;
    font-weight: 600;
  }

  /* Modals */
  .modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.6);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
  }

  /* Toasts */
  .toast {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: #4ade80;
    color: white;
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    font-weight: 600;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    z-index: 2000;
    opacity: 0;
    transition: opacity 0.3s ease;
  }
  .toast.show {
    opacity: 1;
  }
  .toast.error {
    background: #f87171;
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
  let currentProductId = null;
  let currentMaxQty = 30;

  function showQuantityModal(productId, productName, maxStock) {
    currentProductId = productId;
    currentMaxQty = Math.min(30, maxStock);
    document.getElementById('quantityModalTitle').textContent = `Add ${productName} to Cart`;
    document.getElementById('quantityModalInfo').textContent = `Max: ${currentMaxQty} item(s)`;
    document.getElementById('quantityInput').value = 1;
    document.getElementById('quantityInput').max = currentMaxQty;
    document.getElementById('quantityModal').style.display = 'block';
  }

  document.getElementById('qtyDec')?.addEventListener('click', () => {
    const input = document.getElementById('quantityInput');
    let val = parseInt(input.value) || 1;
    input.value = Math.max(1, val - 1);
  });

  document.getElementById('qtyInc')?.addEventListener('click', () => {
    const input = document.getElementById('quantityInput');
    let val = parseInt(input.value) || 1;
    input.value = Math.min(currentMaxQty, val + 1);
  });

  document.getElementById('quantityInput')?.addEventListener('change', (e) => {
    let val = parseInt(e.target.value) || 1;
    val = Math.max(1, Math.min(currentMaxQty, val));
    e.target.value = val;
  });

  document.getElementById('cancelQty')?.addEventListener('click', () => {
    document.getElementById('quantityModal').style.display = 'none';
  });

  document.getElementById('confirmQty')?.addEventListener('click', async () => {
    const quantity = parseInt(document.getElementById('quantityInput').value);
    if (isNaN(quantity) || quantity < 1 || quantity > currentMaxQty) {
      const toast = document.getElementById('cartToast');
      toast.textContent = `Enter 1‚Äì${currentMaxQty}`;
      toast.className = 'toast error';
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 2500);
      return;
    }

    try {
      const res = await fetch(`/products/add/${currentProductId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ quantity })
      });
      const data = await res.json();
      document.getElementById('quantityModal').style.display = 'none';
      
      const toast = document.getElementById('cartToast');
      toast.textContent = data.message || '‚úÖ Added to cart!';
      toast.className = 'toast';
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 2500);
    } catch (err) {
      document.getElementById('quantityModal').style.display = 'none';
      const toast = document.getElementById('cartToast');
      toast.textContent = '‚ùå Failed to add to cart.';
      toast.className = 'toast error';
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 2500);
    }
  });

  document.addEventListener('click', (e) => {
    if (e.target.classList.contains('add-to-cart-btn')) {
      const btn = e.target;
      showQuantityModal(
        btn.dataset.productId,
        btn.dataset.productName,
        parseInt(btn.dataset.productStock, 10)
      );
    }
  });

  document.addEventListener('click', (e) => {
    if (e.target.classList.contains('order-now-btn')) {
      const btn = e.target;
      const item = {
        _id: btn.dataset.productId,
        name: btn.dataset.productName,
        price: parseFloat(btn.dataset.productPrice),
        quantity: 1
      };
      window.orderItems = [item];
      document.getElementById("modalTotal").textContent = item.price.toFixed(2);
      renderOrderSummary();
      document.getElementById("orderModal").style.display = "flex";
    }
  });

  document.getElementById('closeModalBtn')?.addEventListener('click', () => {
    document.getElementById('orderModal').style.display = 'none';
  });

  window.onclick = (e) => {
    if (e.target.id === 'quantityModal' || e.target.id === 'orderModal') {
      e.target.style.display = 'none';
    }
  };

  function renderOrderSummary() {
    const summary = document.getElementById('orderSummary');
    if (!window.orderItems || window.orderItems.length === 0) {
      summary.innerHTML = '<p>No items selected.</p>';
      return;
    }

    let html = '<ul style="list-style:none; padding:0; margin:0;">';
    let total = 0;
    window.orderItems.forEach(item => {
      const itemTotal = item.price * item.quantity;
      total += itemTotal;
      html += `
        <li style="display:flex; justify-content:space-between; margin-bottom:0.5rem;">
          <span>${item.name} √ó ${item.quantity}</span>
          <span>$${itemTotal.toFixed(2)}</span>
        </li>
      `;
    });
    html += '</ul>';
    summary.innerHTML = html;
    document.getElementById('modalTotal').textContent = total.toFixed(2);
  }

  document.getElementById('submitOrderBtn')?.addEventListener('click', async () => {
    const address = document.getElementById('modalAddress').value.trim();
    const paymentMethod = document.getElementById('modalPayment').value;
    if (!address || !window.orderItems || window.orderItems.length === 0) {
      alert('Please fill all fields.');
      return;
    }

    const items = window.orderItems.map(item => ({
      _id: item._id,
      name: item.name,
      price: item.price,
      quantity: item.quantity
    }));
    const total = parseFloat(document.getElementById('modalTotal').textContent);

    try {
      const res = await fetch('/orders/create', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ shippingAddress: address, paymentMethod, items, total })
      });
      const result = await res.json();
      document.getElementById('orderModal').style.display = 'none';

      if (result.success) {
        const toast = document.getElementById('successToast');
        toast.classList.add('show');
        setTimeout(() => {
          toast.classList.remove('show');
          window.location.href = '/orders';
        }, 2000);
      } else {
        alert('‚ùå ' + (result.message || 'Order failed.'));
      }
    } catch (err) {
      alert('‚ö†Ô∏è Network error.');
    }
  });

  window.renderOrderSummary = renderOrderSummary;
});
</script>